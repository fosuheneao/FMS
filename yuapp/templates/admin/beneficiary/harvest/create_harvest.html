{% extends "base_auth_dash.html" %}
{% load static %}

{% block content %}
<div class="col-lg-12">
<style>
  .backIcon:hover {
      color: white !important;
  }
</style>

<div class="card">
  <div class="card-body">
      <h5 class="card-title">
          {% if is_update %} Edit Harvest Record:
              <span class="text-danger">{{ crop.name }}</span>
          {% else %} Create Harvest Record:
              <span class="text-secondary">{{ crop.name }}</span>
          {% endif %}
          &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
          <span class="btn btn-outline-primary">
              <a href="{% url 'harvest_index' %}" class="backIcon"><i class="fa fa-mail-reply-all"></i> Go Back</a>
          </span>
      </h5>

      {% if form.errors %}
      <div class="alert alert-danger alert-dismissible">
          <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
          <strong>Errors:</strong>
          <ul>
              {% for field in form %}
                  {% if field.errors %}
                      <li><strong>{{ field.label }}:</strong>
                          <ul>
                              {% for error in field.errors %}
                                  <li>{{ error }}</li>
                              {% endfor %}
                          </ul>
                      </li>
                  {% endif %}
              {% endfor %}
              {% for error in form.non_field_errors %}
                  <li>{{ error }}</li>
              {% endfor %}
          </ul>
      </div>
      {% endif %}

      <form method="post" action="{% if is_update %}{% url 'update_harvest' harvest_id=harvest.id %}{% else %}{% url 'create_harvest' crop_assigned_id=crop.id %}{% endif %}">
          {% csrf_token %}
          <div class="mb-3">
              {{ form.date.label_tag }}
              {{ form.date }}
          </div>

          <div class="row">
              <div class="col-md-4 mb-3">
                  {{ form.quantity.label_tag }}
                  {{ form.quantity }}
              </div>
              <div class="col-md-4 mb-3">
                  {{ form.grade.label_tag }}
                  {{ form.grade }}
              </div>
              <div class="col-md-4 mb-3">
                  {{ form.unit.label_tag }}
                  {{ form.unit }}
              </div>
          </div>

          <div class="row">
              <div class="mb-3 col-md-6">
                  <label for="price-display">Price (per unit):</label>
                  <input type="text" id="price-display" class="form-control" value="{% if is_update %}{{ harvest.price }}{% endif %}">
                  <input type="hidden" id="price_record" class="form-control" value="{% if is_update %}{{ harvest.price_record.id }}{% endif %}">
                 
                 
                  <input type="hidden" name="total_price" id="total-price-display">
                  <input type="hidden" name="price_record" id="price_record_id">
                                 
                </div>

              <div class="mb-3 col-md-6">
                  <label for="total-price-display">Total Price:</label>
                  <input type="text" id="total-price-display_2" class="form-control" value="{% if is_update %}{{ harvest.total_price }}{% endif %}">    
                </div>
          </div>

          <div class="mb-3">
              {{ form.description.label_tag }}
              {{ form.description }}
          </div>

          <button type="submit" id="save-harvest-btn" class="btn btn-outline-primary" disabled>
              <i class="fa fa-check-square-o"></i> {% if is_update %} Update Harvest Record {% else %} Save Harvest {% endif %}
          </button>
      </form>

      <!-- JavaScript to fetch price and calculate total -->
      <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
      <script>
        
    $(document).ready(function() {
              // Enable save button based on form validation
              function enableSaveButton() {
                  const gradeSelected = $('#id_grade').val();
                  const unitSelected = $('#id_unit').val();
                  const quantityEntered = $('#id_quantity').val();
                  if (gradeSelected && unitSelected && quantityEntered) {
                      $('#save-harvest-btn').prop('disabled', false);
                  } else {
                      $('#save-harvest-btn').prop('disabled', true);
                  }
              }

              // Fetch price when grade or unit is changed
              $('#id_grade, #id_unit').change(function() {
                  const gradeId = $('#id_grade').val();
                  const unitId = $('#id_unit').val();
                  fetchPrice(gradeId, unitId);
                  calculateTotalPrice();
              });

              // Calculate total price when quantity is entered/changed
              $('#id_quantity').on('input', function() {
                  enableSaveButton();
                  calculateTotalPrice();
              });

              function fetchPrice(gradeId, unitId) {
                  if (gradeId && unitId) {
                      $.ajax({
                          url: "{% url 'get_price_for_grade_and_unit' %}",
                          data: {
                              'grade_id': gradeId,
                              'unit_id': unitId,
                              'crop_id': "{{ crop.id }}"
                          },
                          dataType: 'json',
                          success: function(data) {
                            console.log(data);
                              if (data.price) {
                                  $('#price-display').val(data.price);
                                  $('#price_record').val(data.price_id);
                                 $('#price_record_id').val(data.price_id);
                                  calculateTotalPrice();
                              } else {
                                  $('#price-display').val('No price available');
                                  $('#total-price-display').val('');
                                  $('#total-price-display_2').val('');
                                  $('#price_record_id').val('');
                              }
                              enableSaveButton();
                          },
                          error: function() {
                              alert("Failed to fetch price. Please try again later.");
                          }
                      });
                  }
              }

              function calculateTotalPrice() {
                  const price = parseFloat($('#price-display').val());
                  const quantity = parseFloat($('#id_quantity').val());

                  if (!isNaN(price) && !isNaN(quantity)) {
                      const total = price * quantity;
                      $('#total-price-display').val(total.toFixed(2));
                      $('#total-price-display_2').val(total.toFixed(2));
                  } else {
                      $('#total-price-display').val('');
                      $('#total-price-display_2').val('');
                  }
              }

              // Initialize button state
              enableSaveButton();
          }); 
      </script>
  </div>
</div>
{% endblock content %}
